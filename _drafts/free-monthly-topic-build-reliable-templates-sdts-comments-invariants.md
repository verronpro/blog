---
layout: article
title: "Build Reliable Templates: SDTs, Comments, and Invariants"
date: 202X-XX-XX 09:00:00
categories: [ TODO ]
tags: [ wordprocessingml, docs-as-code, craftsmanship, agility, solo-maintainer,
        enterprise, sdt, comments, invariants ]
author: Joseph
description: " TODO "
---

# Why this topic for June

June 2023 didn’t bring a standout human‑authored commit, so I’m using
this month to document a practice that quietly makes or breaks
real‑world stamping projects: designing reliable templates. If you’ve
ever opened a .docx full of content controls (SDTs), comments, fields,
and half a dozen variations of the same placeholder, you know that the
template—not the engine—is your primary source of truth. As a solo
maintainer whose library is adopted sporadically by large organizations,
I’ve learned that the best way to ship on time is to set clear
invariants for templates and treat them as code.

# The problem we keep seeing

WordprocessingML is a flexible, sometimes unpredictable tree. Authors
mix comments that drive processors (e.g., `displayIf`, `repeat`,
`replaceWith`) with SDTs that encapsulate repeating sections or forms.
They paste content from other documents, bringing along styles, fields,
and phantom runs. The result is fragile: placeholders cross SDT
boundaries, comments start in one run and end three runs later, and
empty paragraphs proliferate. Downstream, the stamping pipeline has to
guess intent, and “heisenbugs” appear when a slight layout change breaks
an assumption.

# Invariants that make templates robust

- Keep control metadata local and ephemeral Control comments that drive
  a transformation should live as close as possible to the region they
  affect and be removed once the transformation runs. This prevents
  later processors—or downstream tools—from reinterpreting stale
  metadata.

- Respect SDT boundaries SDTs define ownership. Avoid starting a
  comment‑driven operation in one SDT and ending it in another. Treat
  each SDT as a mini‑document: repeat within it, display/hide within it,
  and keep placeholders contiguous.

- Make placeholders atomic Resist the urge to split a placeholder across
  multiple runs for visual effects. Keep them contiguous text when
  possible, and use explicit APIs like `Paragraph.replace` in the engine
  to perform “text surgery” instead of ad‑hoc string hacks in the
  template. Atomic placeholders mean fewer surprises during traversal.

- Prefer declarative spans to implicit guesses If an operation targets a
  specific range, mark it with a comment range
  (`w:commentRangeStart`/`End`) rather than relying on positional
  heuristics. Named, visible spans are easier to reason about and test.

# Agile and craftsmanship lens

- Shift quality left Normalize inputs before stamping. A preprocessor
  such as `PreparePlaceholders` can clean up placeholder boundaries so
  processors downstream assume cleaner inputs. This narrows edge cases
  and speeds up delivery.

- Treat templates as code Store canonical templates under version
  control. Review them like PRs. Keep an ADR for conventions (e.g.,
  where to place comments, how to name SDTs, which placeholders are
  allowed in headers/footers). Small, explicit rules beat folklore.

- Test with fixtures For tricky structures—nested SDTs, interleaved
  fields and comments—build tiny fixtures in tests. Characterization
  tests will catch regressions and give contributors a concrete
  reference. These fixtures double as documentation‑as‑code.

# Solo maintainer + enterprise usage angle

A team inside a big company might only adopt Office‑stamper for a few
weeks each quarter. They don’t have time to learn WordprocessingML
internals, and I can’t pair with every team. Clear invariants make the
system hospitable: newcomers can apply recipes (“place comment ranges
like this,” “avoid crossing SDT boundaries”) and get predictable
results. Security and platform reviewers value the discipline
too—well‑scoped SDTs and ephemeral comments reduce the risk of
unexpected behavior in post‑processing or downstream tools.

# How to apply this now

- Create a short “Template Conventions” page in your repo. Include
  do/don’t examples with before/after screenshots.

- Add a pre‑normalization step to your stamping configuration (see
  `PreparePlaceholders`). Keep it deterministic and fast.

- Put a linter checklist in PRs for template changes: contiguous
  placeholders, comment ranges do not cross SDTs, no empty control
  scaffolding left behind.

- Build a small library of test fixtures that mirror your most common
  patterns. Reference them from your docs.

# References

- Engine features that help: `PreparePlaceholders` preprocessor,
  `Paragraph.replace`, `DocxIterator` helpers.

- Related posts: Post‑processing in `DocxStamper` (Dec 2024), Delete
  comments from `SdtRun` (Jun 2025).
